name: Build and Release

on:
  release:
    types: [created]

permissions:
  contents: write        # allow uploading assets to the Release page

jobs:
  build:
    # Switch to a Debian runner
    runs-on: debian-latest # Or debian-12, debian-11 etc.

    steps:
      # 1 Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2 Extract version tag
      - name: Get release tag
        id: get_tag
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >>"$GITHUB_OUTPUT"

      # 3 Fast Go installer (≈3 s on Ubuntu) - Should work fine on Debian too
      - name: Setup Go (fast)
        uses: WillAbides/setup-go-faster@v1.14.0
        with:
          go-version: '1.21.x'

      # 4 Enable Arm64 multi‑arch & install build deps (Debian syntax)
      - name: Install cross‑tool‑chains & PAM headers
        run: |
          sudo dpkg --add-architecture arm64
          # Update package lists after adding the new architecture
          sudo apt-get update -qq
          # Install dependencies - package names are likely the same
          sudo apt-get install -y --no-install-recommends \
            build-essential                                     \
            gcc-aarch64-linux-gnu                               \ # cross C compiler
            libpam0g-dev                                        \ # pam_appl.h for amd64 (native)
            libpam0g-dev:arm64                                    # pam_appl.h for arm64 (foreign)

      # 5 Cache Go modules & build cache
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          # Adjust cache key for the OS change
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # 6 Build linux/amd64 (native)
      - name: Build linux/amd64
        run: |
          mkdir -p dist
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
          go build -ldflags="-s -w" \
              -o dist/clab-api-server-linux-amd64 ./cmd/server

      # 7 Build linux/arm64 (cross‑compile)
      - name: Build linux/arm64
        env:
          # CC might need adjustment if the compiler name differs on Debian,
          # but aarch64-linux-gnu-gcc is standard.
          CC: aarch64-linux-gnu-gcc
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 \
          go build -ldflags="-s -w" \
              -o dist/clab-api-server-linux-arm64 ./cmd/server

      # 8 Make binaries executable
      - name: Set execute bits
        run: chmod +x dist/clab-api-server-linux-*

      # 9 Upload binaries to the GitHub Release
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/clab-api-server-linux-amd64
            dist/clab-api-server-linux-arm64
